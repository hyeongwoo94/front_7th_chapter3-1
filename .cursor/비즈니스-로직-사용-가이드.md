# 비즈니스 로직 사용 가이드

## 개요

이 프로젝트는 **뷰 로직**과 **비즈니스 로직**을 분리하여 유지보수성과 테스트 가능성을 높였습니다.

## 구조

```
src/
├── lib/
│   ├── business-rules.ts    # 비즈니스 규칙 (권한, 액션 등)
│   ├── validation.ts        # 검증 로직
│   └── stats.ts             # 통계 계산 로직
├── hooks/
│   └── useManagementPage.ts # 페이지별 비즈니스 로직 훅
└── components/
    ├── ui/                   # 순수 UI 컴포넌트
    └── organisms/            # 조합된 컴포넌트
```

## 비즈니스 로직 사용 방법

### 1. 직접 Import하여 사용

가장 간단한 방법입니다. 필요한 함수를 import해서 사용합니다.

#### 예시 1: 권한 체크

```typescript
import { canDeleteUser, canEditUser } from '@/lib/business-rules';
import type { User } from '@/lib/business-rules';

function UserActions({ user }: { user: User }) {
  // 비즈니스 로직으로 권한 체크
  const canDelete = canDeleteUser(user);
  const canEdit = canEditUser(user);

  return (
    <div>
      {canEdit && (
        <Button onClick={handleEdit}>수정</Button>
      )}
      {canDelete && (
        <Button variant="danger" onClick={handleDelete}>
          삭제
        </Button>
      )}
    </div>
  );
}
```

#### 예시 2: 버튼 Variant 결정

```typescript
import { 
  getButtonVariantFromAction, 
  getButtonLabelFromAction 
} from '@/lib/business-rules';

function ActionButton({ 
  action, 
  entityType 
}: { 
  action: "create" | "edit" | "delete";
  entityType?: "user" | "post";
}) {
  // 비즈니스 로직으로 버튼 스타일 결정
  const variant = getButtonVariantFromAction(action);
  const label = getButtonLabelFromAction(action, entityType);

  return (
    <Button variant={variant} onClick={handleAction}>
      {label}
    </Button>
  );
}
```

#### 예시 3: 게시글 상태 관리

```typescript
import { 
  canPublishPost, 
  canArchivePost, 
  canRestorePost 
} from '@/lib/business-rules';
import type { Post } from '@/lib/business-rules';

function PostActions({ post }: { post: Post }) {
  const canPublish = canPublishPost(post);
  const canArchive = canArchivePost(post);
  const canRestore = canRestorePost(post);

  return (
    <div className="flex gap-2">
      {canPublish && (
        <Button 
          variant="success" 
          onClick={() => handlePublish(post.id)}
        >
          게시
        </Button>
      )}
      {canArchive && (
        <Button 
          variant="secondary" 
          onClick={() => handleArchive(post.id)}
        >
          보관
        </Button>
      )}
      {canRestore && (
        <Button 
          variant="primary" 
          onClick={() => handleRestore(post.id)}
        >
          복원
        </Button>
      )}
    </div>
  );
}
```

### 2. Custom Hook에서 사용

복잡한 비즈니스 로직은 Custom Hook에서 관리합니다.

#### 예시: useManagementPage Hook

```typescript
// hooks/useManagementPage.ts
import { canDeleteUser, canEditUser } from '@/lib/business-rules';
import type { User } from '@/lib/business-rules';

export function useManagementPage() {
  const [users, setUsers] = useState<User[]>([]);
  const [selectedUser, setSelectedUser] = useState<User | null>(null);

  // 비즈니스 로직으로 삭제 가능 여부 체크
  const handleDeleteClick = (user: User) => {
    if (!canDeleteUser(user)) {
      alert('관리자는 삭제할 수 없습니다.');
      return;
    }
    
    if (confirm('정말 삭제하시겠습니까?')) {
      // 삭제 로직
      deleteUser(user.id);
    }
  };

  // 비즈니스 로직으로 수정 가능 여부 체크
  const handleEditClick = (user: User) => {
    if (!canEditUser(user)) {
      alert('관리자는 수정할 수 없습니다.');
      return;
    }
    
    setSelectedUser(user);
    setIsEditModalOpen(true);
  };

  return {
    users,
    handleDeleteClick,
    handleEditClick,
    // ...
  };
}
```

#### 컴포넌트에서 Hook 사용

```typescript
// pages/ManagementPage.tsx
import { useManagementPage } from '@/hooks/useManagementPage';

export const ManagementPage: React.FC = () => {
  const {
    users,
    handleDeleteClick,
    handleEditClick,
  } = useManagementPage();

  return (
    <Table
      data={users}
      onEdit={handleEditClick}      // ✅ 비즈니스 로직이 포함된 핸들러
      onDelete={handleDeleteClick}   // ✅ 비즈니스 로직이 포함된 핸들러
    />
  );
};
```

### 3. Service Layer에서 사용

데이터 처리와 비즈니스 로직을 함께 관리할 때 사용합니다.

#### 예시: UserService

```typescript
// services/userService.ts
import { canDeleteUser } from '@/lib/business-rules';
import type { User } from '@/lib/business-rules';

export const userService = {
  async delete(id: number, user: User): Promise<void> {
    // 비즈니스 로직 체크
    if (!canDeleteUser(user)) {
      throw new Error('관리자는 삭제할 수 없습니다.');
    }
    
    // 실제 삭제 로직
    // ...
  },
};
```

## 실제 사용 예시 (완전한 예제)

### 예시: Table 컴포넌트에서 비즈니스 로직 사용

```typescript
// components/organisms/Table.tsx
import { 
  canDeleteUser, 
  canEditUser,
  canPublishPost,
  canArchivePost,
  getButtonVariantFromAction 
} from '@/lib/business-rules';
import type { User, Post } from '@/lib/business-rules';

interface TableProps {
  data: (User | Post)[];
  entityType: 'user' | 'post';
  onEdit?: (item: User | Post) => void;
  onDelete?: (id: number) => void;
  onPublish?: (id: number) => void;
  onArchive?: (id: number) => void;
}

export const Table: React.FC<TableProps> = ({
  data,
  entityType,
  onEdit,
  onDelete,
  onPublish,
  onArchive,
}) => {
  // 비즈니스 로직으로 액션 버튼 렌더링
  const renderActions = (item: User | Post) => {
    if (entityType === 'user') {
      const user = item as User;
      const canEdit = canEditUser(user);
      const canDelete = canDeleteUser(user);

      return (
        <div className="flex gap-2">
          {canEdit && (
            <Button 
              variant="primary" 
              size="sm"
              onClick={() => onEdit?.(user)}
            >
              수정
            </Button>
          )}
          {canDelete && (
            <Button 
              variant="danger" 
              size="sm"
              onClick={() => onDelete?.(user.id)}
            >
              삭제
            </Button>
          )}
        </div>
      );
    } else {
      const post = item as Post;
      const canPublish = canPublishPost(post);
      const canArchive = canArchivePost(post);

      return (
        <div className="flex gap-2">
          {canPublish && (
            <Button 
              variant={getButtonVariantFromAction('publish')}
              size="sm"
              onClick={() => onPublish?.(post.id)}
            >
              게시
            </Button>
          )}
          {canArchive && (
            <Button 
              variant={getButtonVariantFromAction('archive')}
              size="sm"
              onClick={() => onArchive?.(post.id)}
            >
              보관
            </Button>
          )}
        </div>
      );
    }
  };

  return (
    <table>
      {/* 테이블 헤더 */}
      <tbody>
        {data.map((item) => (
          <tr key={item.id}>
            {/* 테이블 셀들 */}
            <td>{renderActions(item)}</td>
          </tr>
        ))}
      </tbody>
    </table>
  );
};
```

## 비즈니스 로직 추가 방법

### 1. 새로운 비즈니스 규칙 추가

```typescript
// lib/business-rules.ts

// 새로운 규칙 추가
export function canViewUserDetails(user: User, currentUser: User): boolean {
  // 본인이거나 관리자인 경우만 조회 가능
  return user.id === currentUser.id || currentUser.role === 'admin';
}

export function canChangeUserRole(user: User, newRole: string): boolean {
  // 관리자 역할은 변경 불가
  if (user.role === 'admin') return false;
  // 본인 역할은 변경 불가
  return user.role !== newRole;
}
```

### 2. 사용하기

```typescript
import { canViewUserDetails, canChangeUserRole } from '@/lib/business-rules';

function UserDetailPage({ user, currentUser }: Props) {
  const canView = canViewUserDetails(user, currentUser);
  const canChangeRole = canChangeUserRole(user, 'moderator');

  if (!canView) {
    return <div>접근 권한이 없습니다.</div>;
  }

  return (
    <div>
      <h1>{user.name}</h1>
      {canChangeRole && (
        <Button onClick={handleRoleChange}>역할 변경</Button>
      )}
    </div>
  );
}
```

## 장점

### 1. 재사용성
```typescript
// 여러 컴포넌트에서 같은 비즈니스 로직 사용
import { canDeleteUser } from '@/lib/business-rules';

// UserTable.tsx
const canDelete = canDeleteUser(user);

// UserCard.tsx
const canDelete = canDeleteUser(user);

// UserModal.tsx
const canDelete = canDeleteUser(user);
```

### 2. 테스트 용이성
```typescript
// __tests__/business-rules.test.ts
import { canDeleteUser } from '@/lib/business-rules';

describe('canDeleteUser', () => {
  it('관리자는 삭제할 수 없다', () => {
    const admin = { id: 1, role: 'admin' };
    expect(canDeleteUser(admin)).toBe(false);
  });

  it('일반 사용자는 삭제할 수 있다', () => {
    const user = { id: 2, role: 'user' };
    expect(canDeleteUser(user)).toBe(true);
  });
});
```

### 3. 유지보수성
```typescript
// 비즈니스 규칙이 변경되면 한 곳만 수정
// lib/business-rules.ts
export function canDeleteUser(user: User): boolean {
  // 규칙 변경: 관리자도 삭제 가능하도록 변경
  return true; // 모든 사용자 삭제 가능
}

// 모든 컴포넌트에 자동 반영됨!
```

## 주의사항

### ❌ 나쁜 예: 비즈니스 로직을 컴포넌트에 직접 작성

```typescript
// ❌ 나쁜 예
function UserActions({ user }: { user: User }) {
  // 비즈니스 로직이 컴포넌트에 하드코딩됨
  const canDelete = user.role !== "admin";
  const canEdit = user.role !== "admin";

  return (
    <div>
      {canDelete && <Button>삭제</Button>}
    </div>
  );
}
```

### ✅ 좋은 예: 비즈니스 로직을 분리

```typescript
// ✅ 좋은 예
import { canDeleteUser, canEditUser } from '@/lib/business-rules';

function UserActions({ user }: { user: User }) {
  // 비즈니스 로직을 import해서 사용
  const canDelete = canDeleteUser(user);
  const canEdit = canEditUser(user);

  return (
    <div>
      {canDelete && <Button>삭제</Button>}
    </div>
  );
}
```

## 요약

1. **직접 Import**: 간단한 비즈니스 로직은 `import`로 가져와서 사용
2. **Custom Hook**: 복잡한 로직은 Hook에서 관리
3. **Service Layer**: 데이터 처리와 함께 관리할 때 사용
4. **테스트**: 비즈니스 로직은 독립적으로 테스트 가능
5. **재사용**: 여러 컴포넌트에서 같은 로직 재사용 가능

## 참고 파일

- `src/lib/business-rules.ts` - 비즈니스 규칙 정의
- `src/hooks/useManagementPage.ts` - 페이지별 비즈니스 로직 훅
- `src/lib/validation.ts` - 검증 로직
- `src/lib/stats.ts` - 통계 계산 로직

